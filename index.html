<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CherryTV - Premium Streaming</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');

        :root {
            --cherry: #ff2d55;
            --cherry-glow: rgba(255, 45, 85, 0.4);
            --bg: #030407;
            --surface: #0a0c12;
            --glass: rgba(15, 18, 24, 0.7);
            --text: #ffffff;
            --dim: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at top right, rgba(255, 45, 85, 0.08), transparent);
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 20px;
            overflow-x: hidden;
        }

        .container { width: 100%; max-width: 950px; display: flex; flex-direction: column; gap: 24px; }

        header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .logo-box { display: flex; align-items: center; gap: 10px; }
        .logo-icon { color: var(--cherry); font-size: 22px; filter: drop-shadow(0 0 8px var(--cherry-glow)); }
        .logo-text { font-size: 1.4rem; font-weight: 800; letter-spacing: -1px; }

        #status-badge {
            font-size: 9px; font-weight: 800; color: #fff;
            background: var(--cherry); padding: 5px 12px; 
            border-radius: 50px; text-transform: uppercase;
            box-shadow: 0 0 15px var(--cherry-glow);
        }

        .player-wrapper {
            position: relative; background: #000; border-radius: 24px;
            overflow: hidden; aspect-ratio: 16 / 9; width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        video { width: 100%; height: 100%; object-fit: contain; pointer-events: auto; }

        /* Fullscreen Video Fixes */
        video:-webkit-full-screen { width: 100%; height: 100%; }
        .player-wrapper:fullscreen { border-radius: 0; border: none; }
        .player-wrapper:fullscreen video { width: 100vw; height: 100vh; }

        .overlay { 
            position: absolute; inset: 0; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 50; 
            background: var(--bg); transition: opacity 0.4s ease; 
        }
        .hidden { opacity: 0 !important; pointer-events: none !important; }

        .spinner {
            width: 44px; height: 44px; border: 3px solid rgba(255, 255, 255, 0.05);
            border-top: 3px solid var(--cherry); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .controls-layer {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            z-index: 100; opacity: 1; transition: opacity 0.3s;
        }

        .controls-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass); backdrop-filter: blur(20px);
            padding: 10px 18px; border-radius: 18px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        button { background: none; border: none; color: #fff; cursor: pointer; font-size: 18px; padding: 8px; }
        button:active { transform: scale(0.9); color: var(--cherry); }

        .info-card {
            background-color: var(--surface); padding: 24px; border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.03); text-align: center;
        }

        .video-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.5px; }
        .video-subtitle { font-size: 10px; font-weight: 600; color: var(--dim); text-transform: uppercase; letter-spacing: 1.5px; }

        py-script, py-config { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo-box">
                <i class="fas fa-play logo-icon"></i>
                <h1 class="logo-text">CherryTV</h1>
            </div>
            <div id="status-badge">Engine Core</div>
        </header>

        <div id="video-scope" class="player-wrapper">
            <video id="v-element" crossorigin="anonymous" playsinline webkit-playsinline autoplay muted></video>

            <div id="v-loader" class="overlay">
                <div class="spinner"></div>
                <p id="boot-text" style="margin-top: 15px; font-size: 10px; color: var(--dim); font-weight: 700; text-transform: uppercase;">Booting Engine...</p>
            </div>

            <div id="v-controls" class="controls-layer">
                <div class="controls-bar">
                    <div class="controls-left" style="display:flex; gap:18px; align-items:center;">
                        <button id="v-play-btn"><i class="fas fa-pause"></i></button>
                        <div style="color:var(--cherry); font-weight:800; font-size:10px;">LIVE</div>
                        <button id="v-mute"><i class="fas fa-volume-mute"></i></button>
                    </div>
                    <div class="controls-right" style="display:flex; gap:18px; align-items:center;">
                        <button id="v-pip"><i class="fas fa-clone"></i></button>
                        <button id="v-full"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-card">
            <p class="video-subtitle">Currently Streaming</p>
            <h2 id="display-name" class="video-title">...</h2>
        </div>
    </div>

    <script type="py" config='{"packages": ["pandas", "pyodide-http"]}'>
import pandas as pd
from pyodide.http import open_url
from pyscript import window
import js

def run_cherry_engine(target_from_js=None):
    try:
        df = pd.read_csv(open_url("./TV.csv"))
        params = window.URLSearchParams.new(window.location.search)
        target = target_from_js or params.get('startapp') or params.get('name')

        if target:
            target_clean = window.decodeURIComponent(target).replace('_', ' ').strip()
            match = df[df['Name'].str.contains(target_clean, case=False, na=False)].head(1)
            if not match.empty:
                js.initStream(match['URL'].values[0], match['Name'].values[0])
            else:
                window.document.getElementById('display-name').textContent = "Not Found"
                window.document.getElementById('v-loader').classList.add('hidden')
        else:
            window.document.getElementById('v-loader').classList.add('hidden')
    except Exception as e:
        print(f"Engine Error: {e}")

window.run_cherry_engine = run_cherry_engine
run_cherry_engine()
    </script>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const player = document.getElementById('v-element');
        const loader = document.getElementById('v-loader');
        const playBtn = document.getElementById('v-play-btn');
        const muteBtn = document.getElementById('v-mute');
        const nameLabel = document.getElementById('display-name');
        const statusBadge = document.getElementById('status-badge');
        const controls = document.getElementById('v-controls');

        window.Telegram.WebApp.expand();

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            let target = params.get('name') || params.get('startapp') || 
                         (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.start_param) ||
                         new URLSearchParams(window.location.hash.substring(1)).get('tgWebAppStartParam');

            if (target) {
                const cleanName = decodeURIComponent(target.replace(/\+/g, ' '));
                const checkPy = setInterval(() => {
                    if (window.run_cherry_engine) {
                        clearInterval(checkPy);
                        window.run_cherry_engine(cleanName);
                    }
                }, 100);
            }
        };

        async function initStream(url, name) {
            nameLabel.textContent = name.replace(/\(\d{3,4}p\)/g, '').trim();
            player.src = url;
            try {
                player.muted = true;
                await player.play();
                loader.classList.add('hidden');
            } catch (err) {
                loader.classList.add('hidden');
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        // --- FULLSCREEN & ROTATION MAGIC ---
        document.getElementById('v-full').onclick = async (e) => {
            e.stopPropagation();
            const wrapper = document.getElementById('video-scope');

            try {
                if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                    // Enter Fullscreen
                    if (wrapper.requestFullscreen) {
                        await wrapper.requestFullscreen();
                    } else if (player.webkitEnterFullscreen) {
                        player.webkitEnterFullscreen(); // iOS native fallback
                        return;
                    } else if (wrapper.webkitRequestFullscreen) {
                        await wrapper.webkitRequestFullscreen();
                    }

                    // Force Rotation (Android/Chrome)
                    if (screen.orientation && screen.orientation.lock) {
                        await screen.orientation.lock('landscape').catch(() => {});
                    }
                } else {
                    // Exit
                    if (document.exitFullscreen) document.exitFullscreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                    
                    if (screen.orientation && screen.orientation.unlock) {
                        screen.orientation.unlock();
                    }
                }
            } catch (err) {
                player.play(); // Last resort gesture
            }
        };

        playBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (player.paused) { player.play(); playBtn.innerHTML = '<i class="fas fa-pause"></i>'; }
            else { player.pause(); playBtn.innerHTML = '<i class="fas fa-play"></i>'; }
        });

        muteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            player.muted = !player.muted;
            muteBtn.innerHTML = player.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        });

        player.addEventListener('click', () => {
            controls.style.opacity = (controls.style.opacity == "0") ? "1" : "0";
        });
    </script>
</body>
</html>
