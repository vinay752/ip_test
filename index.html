<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CherryTV - Premium Streaming</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');

        :root {
            --cherry: #ff2d55;
            --cherry-glow: rgba(255, 45, 85, 0.4);
            --bg: #030407;
            --surface: #0a0c12;
            --glass: rgba(15, 18, 24, 0.7);
            --text: #ffffff;
            --dim: #94a3b8;
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
        }

        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at top right, rgba(255, 45, 85, 0.08), transparent);
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 20px;
            overflow-x: hidden;
        }

        .container { width: 100%; max-width: 950px; display: flex; flex-direction: column; gap: 24px; }

        header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .logo-box { display: flex; align-items: center; gap: 10px; }
        .logo-icon { color: var(--cherry); font-size: 22px; filter: drop-shadow(0 0 8px var(--cherry-glow)); }
        .logo-text { font-size: 1.4rem; font-weight: 800; letter-spacing: -1px; }

        #status-badge {
            font-size: 9px; font-weight: 800; color: #fff;
            background: var(--cherry); padding: 5px 12px; 
            border-radius: 50px; text-transform: uppercase;
            box-shadow: 0 0 15px var(--cherry-glow);
        }

        /* Responsive Player */
        .player-wrapper {
            position: relative; background: #000; border-radius: 24px;
            overflow: hidden; aspect-ratio: 16 / 9; width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            touch-action: none;
        }

        video { width: 100%; height: 100%; object-fit: contain; }

        /* Mobile Loader */
        .overlay { 
            position: absolute; inset: 0; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 20; 
            background: var(--bg); transition: opacity 0.4s ease; 
        }
        .hidden { opacity: 0; pointer-events: none; }

        .spinner {
            width: 44px; height: 44px; border: 3px solid rgba(255, 255, 255, 0.05);
            border-top: 3px solid var(--cherry); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Mobile-First Controls */
        .controls-layer {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            z-index: 30; opacity: 0; transition: opacity 0.3s;
        }
        .player-wrapper:hover .controls-layer, .player-wrapper:active .controls-layer { opacity: 1; }

        .controls-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass); backdrop-filter: blur(20px);
            padding: 10px 18px; border-radius: 18px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .controls-left, .controls-right { display: flex; align-items: center; gap: 18px; }

        button { 
            background: none; border: none; color: #fff; 
            cursor: pointer; font-size: 18px; transition: 0.2s; 
        }
        button:active { transform: scale(0.9); color: var(--cherry); }

        .live-badge { 
            display: flex; align-items: center; gap: 6px; color: var(--cherry); 
            font-weight: 800; font-size: 10px; text-transform: uppercase; 
        }
        .live-dot { width: 6px; height: 6px; background: var(--cherry); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        input[type=range] { accent-color: var(--cherry); width: 60px; height: 4px; }

        .info-card {
            background-color: var(--surface); padding: 24px; border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.03); text-align: center;
        }

        .video-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.5px; }
        .video-subtitle { font-size: 10px; font-weight: 600; color: var(--dim); text-transform: uppercase; letter-spacing: 1.5px; }

        /* PyScript Cleaners */
        py-script, .py-terminal, py-config { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo-box">
                <i class="fas fa-play logo-icon"></i>
                <h1 class="logo-text">CherryTV</h1>
            </div>
            <div id="status-badge">Engine Core</div>
        </header>

        <div id="video-scope" class="player-wrapper">
            <video id="v-element" crossorigin="anonymous" playsinline autoplay></video>

            <div id="v-loader" class="overlay">
                <div class="spinner"></div>
                <p id="boot-text" style="margin-top: 15px; font-size: 10px; color: var(--dim); font-weight: 700; text-transform: uppercase;">Initializing...</p>
            </div>

            <div class="controls-layer">
                <div class="controls-bar">
                    <div class="controls-left">
                        <button id="v-play-btn"><i class="fas fa-play"></i></button>
                        <div class="live-badge"><span class="live-dot"></span>Live</div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button id="v-mute"><i class="fas fa-volume-up"></i></button>
                            <input type="range" id="v-vol" min="0" max="1" step="0.1" value="1">
                        </div>
                    </div>
                    <div class="controls-right">
                        <button id="v-pip"><i class="fas fa-clone"></i></button>
                        <button id="v-full"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-card">
            <p class="video-subtitle">Currently Streaming</p>
            <h2 id="display-name" class="video-title">...</h2>
        </div>
    </div>

    <script type="py" config='{"packages": ["pandas", "pyodide-http"]}'>
import pandas as pd
from pyodide.http import open_url
from pyscript import window
import js

def run_cherry_engine(target_from_js=None):
    """
    The main search engine for CherryTV. 
    It syncs the CSV and finds the stream URL based on the channel name.
    """
    status_badge = window.document.getElementById('status-badge')
    name_label = window.document.getElementById('display-name')
    v_loader = window.document.getElementById('v-loader')
    boot_text = window.document.getElementById('boot-text')

    try:
        # Step 1: Sync the Database
        if boot_text:
            boot_text.textContent = "Syncing Database..."
        
        # Load your TV.csv (ensure this file is in your GitHub folder)
        csv_url = "./TV.csv" 
        df = pd.read_csv(open_url(csv_url))
        
        # Step 2: Get the Channel Name
        # We check the JS handoff first, then fall back to URL params
        params = window.URLSearchParams.new(window.location.search)
        target = target_from_js or params.get('startapp') or params.get('name')

        if target:
            if boot_text:
                boot_text.textContent = "Searching..."
            
            # Clean the target name (Decode URL and fix Telegram underscores)
            target_clean = window.decodeURIComponent(target).replace('_', ' ').strip()
            
            # Step 3: Fast Search Logic
            # First, try an exact match for speed
            match = df[df['Name'] == target_clean]
            
            # If no exact match, try a partial match (finds "Willow TV" in "Willow TV (720p)")
            if match.empty:
                match = df[df['Name'].str.contains(target_clean, case=False, na=False)].head(1)
            
            if not match.empty:
                stream_url = match['URL'].values[0]
                stream_name = match['Name'].values[0]
                
                # Step 4: Hand off to Javascript Player
                js.initStream(stream_url, stream_name)
            else:
                if name_label:
                    name_label.textContent = "Channel Not Found"
                if v_loader:
                    v_loader.classList.add('hidden')
                if status_badge:
                    status_badge.textContent = "404"
        else:
            # Default state if no channel is requested
            if v_loader:
                v_loader.classList.add('hidden')
            if status_badge:
                status_badge.textContent = "Ready"

    except Exception as e:
        if name_label:
            name_label.textContent = "Engine Error"
        print(f"CherryTV Python Error: {e}")

# Expose the function to the Global JS Window so the Loader can call it
window.run_cherry_engine = run_cherry_engine

# Auto-run once on boot to catch any initial URL params
run_cherry_engine()
</script>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
    // Global JS references
    const player = document.getElementById('v-element');
    const loader = document.getElementById('v-loader');
    const playBtn = document.getElementById('v-play-btn');
    const muteBtn = document.getElementById('v-mute');
    const volIn = document.getElementById('v-vol');
    const nameLabel = document.getElementById('display-name');
    const statusBadge = document.getElementById('status-badge');

    // Initialize Telegram WebApp SDK
    const tg = window.Telegram.WebApp;
    tg.expand(); // Opens the app to full height in Telegram

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        
        // --- THE TRIPLE CHECK ---
        // 1. Check standard URL (?name=)
        // 2. Check Telegram SDK (start_param)
        // 3. Check URL Hash (#tgWebAppStartParam)
        let target = params.get('name') || 
                     params.get('startapp') ||
                     (tg.initDataUnsafe && tg.initDataUnsafe.start_param) ||
                     new URLSearchParams(window.location.hash.substring(1)).get('tgWebAppStartParam');

        if (target) {
            // Decode %20 or + into spaces
            const cleanName = decodeURIComponent(target.replace(/\+/g, ' '));
            
            // Wait for PyScript to be ready before calling the engine
            const checkPy = setInterval(() => {
                // We check if the PyScript function is defined in the global scope
                if (window.run_cherry_engine) {
                    clearInterval(checkPy);
                    window.run_cherry_engine(cleanName);
                }
            }, 100);
        } else {
            statusBadge.textContent = "Ready";
            loader.classList.add('hidden');
            nameLabel.textContent = "Awaiting Signal";
        }
    };

    // Called by PyScript
    async function initStream(url, name) {
        statusBadge.textContent = "Live";
        // This removes (720p) etc from the display title
        const displayTitle = name.replace(/\(\d{3,4}p\)/g, '').trim();
        nameLabel.textContent = displayTitle;
        
        player.src = url;
        player.load();
        
        try {
            await player.play();
            loader.classList.add('hidden');
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } catch (err) {
            loader.classList.add('hidden');
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
            statusBadge.textContent = "Paused";
        }
    }

    // --- MOBILE EVENT LISTENERS ---
    playBtn.onclick = () => {
        if (player.paused) { 
            player.play(); 
            playBtn.innerHTML = '<i class="fas fa-pause"></i>'; 
            statusBadge.textContent = "Live";
        } else { 
            player.pause(); 
            playBtn.innerHTML = '<i class="fas fa-play"></i>'; 
            statusBadge.textContent = "Paused";
        }
    };

    muteBtn.onclick = () => {
        player.muted = !player.muted;
        muteBtn.innerHTML = player.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    };

    volIn.oninput = (e) => { 
        player.volume = e.target.value; 
        if (player.volume > 0) player.muted = false;
    };

    document.getElementById('v-full').onclick = () => {
        const wrapper = document.getElementById('video-scope');
        if (!document.fullscreenElement) wrapper.requestFullscreen();
        else document.exitFullscreen();
    };

    document.getElementById('v-pip').onclick = () => {
        if (document.pictureInPictureEnabled) player.requestPictureInPicture();
    };

    player.onclick = () => {
        const layer = document.querySelector('.controls-layer');
        layer.style.opacity = (layer.style.opacity == "1") ? "0" : "1";
    };
</script>
</body>
</html>
